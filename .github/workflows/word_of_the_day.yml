name: Optimized Linux Interval Export

on:
  schedule:
    - cron: '0 16,20,0,4,8,12 * * *'
  workflow_dispatch:

jobs:
  export-next-content:
    runs-on: self-hosted
    environment: production
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # ä½¿ç”¨é¢„å®‰è£…çš„PostgreSQLå®¢æˆ·ç«¯ï¼ˆå¦‚æœRunneré•œåƒå·²åŒ…å«ï¼‰
    - name: Verify PostgreSQL client
      run: |
        if ! command -v psql &> /dev/null; then
          echo "Installing PostgreSQL client..."
          sudo apt-get update
          sudo apt-get install -y postgresql-client
        else
          echo "PostgreSQL client already installed: $(psql --version)"
        fi
    
    - name: Export next content
      env:
        DB_HOST: "ydlj-pg"  # ä½¿ç”¨å®¹å™¨å
        DB_PORT: "5432"     # å®¹å™¨å†…éƒ¨ç«¯å£
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        # ä»æ•°æ®åº“è·å–å½“å¤©æœ€æ—©æœªå‘å¸ƒçš„è®°å½•
        echo "ğŸ” æŸ¥è¯¢ä¸‹ä¸€æ¡æœªå‘å¸ƒè®°å½•..."
        echo "è¿æ¥æ•°æ®åº“: $DB_HOST:$DB_PORT"
        export PGPASSWORD="$DB_PASSWORD"
        psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -t -c "
        SELECT 
          id, 
          html, 
          created_at,
          title
        FROM exports 
        WHERE export_date = CURRENT_DATE 
          AND published = false 
        ORDER BY created_at ASC 
        LIMIT 1;
        " > /tmp/next_record.txt
        
        # å¤„ç†å•æ¡è®°å½•
        if [ -s /tmp/next_record.txt ]; then
          echo "ğŸ“ å¼€å§‹å¤„ç†ä¸‹ä¸€æ¡è®°å½•..."
          
          # ä½¿ç”¨awkå¤„ç†å•æ¡è®°å½•
          awk -F'|' '
          {
            if (NF >= 4) {
              id = $1
              html = $2
              created_at = $3
              title = $4
              
              # æ¸…ç†æ•°æ®
              gsub(/^[ \t]+|[ \t]+$/, "", id)
              gsub(/^[ \t]+|[ \t]+$/, "", html)
              gsub(/^[ \t]+|[ \t]+$/, "", created_at)
              gsub(/^[ \t]+|[ \t]+$/, "", title)
              
              # ç›´æ¥è¦†ç›–åˆ°index.html
              print html > "index.html"
              print "âœ… å¯¼å‡ºè®°å½•: index.html (ID: " id ", æ—¶é—´: " created_at ")"
            }
          }
          ' /tmp/next_record.txt
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆæ–‡ä»¶
          if [ -f "index.html" ]; then
            echo "âœ… æˆåŠŸå¯¼å‡ºå†…å®¹åˆ°index.html"
            echo "ğŸ“ æ–‡ä»¶å¤§å°: $(wc -c < index.html) bytes"
          else
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°æœªå‘å¸ƒè®°å½•ï¼Œè·³è¿‡éƒ¨ç½²"
            exit 0
          fi
        else
          echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°æœªå‘å¸ƒè®°å½•ï¼Œè·³è¿‡éƒ¨ç½²"
          exit 0
        fi
    
    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet HEAD -- index.html; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ²¡æœ‰å†…å®¹å˜æ›´ï¼Œè·³è¿‡æäº¤"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ£€æµ‹åˆ°å†…å®¹å˜æ›´"
        fi
    
    - name: Commit and push changes
      if: steps.changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add index.html
        git commit -m "ğŸ“… Update index.html $(date +%Y-%m-%d-%H-%M)"
        git push origin main
        
        echo "ğŸš€ index.htmlå·²æäº¤å¹¶æ¨é€åˆ°GitHub"
    
    - name: Update database published status
      if: steps.changes.outputs.changes == 'true'
      env:
        DB_HOST: "ydlj-pg"  # ä½¿ç”¨å®¹å™¨å
        DB_PORT: "5432"     # å®¹å™¨å†…éƒ¨ç«¯å£
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        # æ ‡è®°å½“å‰å¤„ç†çš„è®°å½•ä¸ºå·²å‘å¸ƒ
        export PGPASSWORD="$DB_PASSWORD"
        psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "
        UPDATE exports 
        SET published = true 
        WHERE export_date = CURRENT_DATE 
          AND published = false 
          AND id = (
            SELECT id FROM exports 
            WHERE export_date = CURRENT_DATE 
              AND published = false 
            ORDER BY created_at ASC 
            LIMIT 1
          );
        "
        echo "âœ… å½“å‰è®°å½•å·²æ ‡è®°ä¸ºå·²å‘å¸ƒ"
